<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Feed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='feed_style.css') }}">
</head>


<body>
<header>Feed</header>

<div class="search-bar">
  <input type="text" id="search" placeholder="Cerca...">
  <select id="filter">
    <option value="all">Tutti</option>
    <option value="user">Utente</option>
    <option value="title">Titolo</option>
    <option value="file">File</option>
    <option value="tag">Tag</option>
  </select>
  <button onclick="applySearch()">Cerca</button>
</div>

<div class="feed" id="feed"></div>
<div class="loading" id="loading">Caricamento...</div>
<!-- sentinel element for IntersectionObserver lazy loading -->
<div id="feed-sentinel"></div>

<div class="bottom-nav-box">
  <a href="{{ url_for('home.homepage', form_type='profile') }}" class="nav-item">
    <i class="fas fa-user"></i><span>Profile</span>
  </a>
  <a href="{{ url_for('home.homepage', form_type='feed') }}" class="nav-item">
    <i class="fas fa-rss"></i><span>Feed</span>
  </a>
  <a href="{{ url_for('home.homepage', form_type='libraries') }}" class="nav-item">
    <i class="fas fa-book"></i><span>Libraries</span>
  </a>
</div>


<script>
  let currentIndex = 0;
  const batchSize = 10;
  let currentFilter = 'all';
  let currentSearch = '';
  let isLoading = false;
  let endReached = false;

  const feedEl = document.getElementById('feed');
  const loadingEl = document.getElementById('loading');
  const sentinel = document.getElementById('feed-sentinel');

  function getMediaIcon(type) {
    switch (type) {
      case 'song':
        return '/static/images/song.png';
      case 'document':
        return '/static/images/document.png';
      case 'video':
        return '/static/images/video.png';
      default:
        return '/static/images/unknown.jpg';
    }
  }

  async function loadMore() {
    if (isLoading || endReached) return;
    isLoading = true;
    loadingEl.textContent = "Caricamento...";
    
    try {
      const res = await fetch(`/feed/data?offset=${currentIndex}&limit=${batchSize}&filter=${currentFilter}&search=${encodeURIComponent(currentSearch)}`);
      const data = await res.json();

      if (res.ok) {
        if (currentIndex === 0) feedEl.innerHTML = '';
        if (!data || data.length === 0) {
          loadingEl.textContent = "Fine dei risultati";
          endReached = true;
          return;
        }

        data.forEach(item => {
          const div = document.createElement('div');
          div.className = 'media-item';

          const img = document.createElement('img');
          img.className = 'media-icon';
          img.src = getMediaIcon(item.type);
          img.alt = item.type || '';

          const info = document.createElement('div');
          info.className = 'media-info';

          const h3 = document.createElement('h3');
          const a = document.createElement('a');
          // link to the detailed show page; prefer an id field, fall back to link
          const mediaId = item.id || item.media_id || item._id || item.link || '';
          a.href = `/show?media_id=${encodeURIComponent(mediaId)}`;
          a.target = '_blank';
          a.textContent = item.title || 'Untitled';
          h3.appendChild(a);

          const byP = document.createElement('p');
          const username = item.username;
          if (username) {
            const profileLink = document.createElement('a');
            profileLink.href = `/home/?form_type=profile&username=${encodeURIComponent(username)}`;
            profileLink.textContent = username;
            byP.appendChild(document.createTextNode('By: '));
            byP.appendChild(profileLink);
          } else {
            byP.textContent = 'By: Sconosciuto';
          }

          const tagsP = document.createElement('p');
          tagsP.textContent = 'Tag: ' + (Array.isArray(item.tags) ? item.tags.join(', ') : '-');

          info.appendChild(h3);
          info.appendChild(byP);
          info.appendChild(tagsP);

          div.appendChild(img);
          div.appendChild(info);

          feedEl.appendChild(div);
        });


        currentIndex += data.length;
        loadingEl.textContent = "";
      } else {
        loadingEl.textContent = "Errore nel caricamento";
      }
    } catch (err) {
      console.error(err);
      loadingEl.textContent = "Errore di rete";
    } finally {
      isLoading = false;
    }
  }

  // Use an IntersectionObserver on a sentinel element located after the feed
  // so we load more when the sentinel becomes visible.
  const observer = new IntersectionObserver((entries) => {
    for (const entry of entries) {
      if (entry.isIntersecting) {
        loadMore();
      }
    }
  }, { root: null, rootMargin: '200px', threshold: 0.1 });

  function applySearch() {
    currentIndex = 0;
    feedEl.innerHTML = '';
    currentSearch = document.getElementById('search').value;
    currentFilter = document.getElementById('filter').value;
    endReached = false;
    loadMore();
  }

  window.addEventListener('DOMContentLoaded', () => {
    observer.observe(sentinel);
    loadMore();
  });
</script>

</body>
</html>

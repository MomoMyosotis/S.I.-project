<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Feed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='feed_style.css') }}">
</head>

<body>
<header>Feed</header>

<div class="search-bar">
  <input type="text" id="search" placeholder="Cerca... (nome, tag, YYYY, author, performer, instrument)">
  <select id="filter">
    <option value="all">Tutti</option>
    <option value="user">Utente</option>
    <option value="title">Titolo</option>
    <option value="file">File</option>
    <option value="tag">Tag</option>
    <option value="date">Data pubblicazione</option>
    <option value="publisher">Publisher</option>
    <option value="author">Autore</option>
    <option value="performer">Interprete</option>
    <option value="instrument">Strumento</option>
  </select>
  <button onclick="applySearch()">Cerca</button>
</div>

<div class="feed" id="feed"></div>
<div class="loading" id="loading">Caricamento...</div>
<div id="feed-sentinel"></div>

<script>
  let currentIndex = 0;
  const batchSize = 10;

  let currentFilter = 'all';
  let currentSearch = '';
  let isLoading = false;
  let endReached = false;
  let loadToken = 0;

  const feedEl = document.getElementById('feed');
  const loadingEl = document.getElementById('loading');
  const sentinel = document.getElementById('feed-sentinel');

  let observer;

  const mediaIcons = {
    song: '/static/images/song.png',
    document: '/static/images/document.png',
    video: '/static/images/video.png',
    link: '/static/images/concert.png',
    concert: '/static/images/concert.png',
    default: '/static/images/unknown.jpg'
  };

  const el = (tag, className, text) => {
    const e = document.createElement(tag);
    if (className) e.className = className;
    if (text !== undefined) e.textContent = text;
    return e;
  };

  function truncateTitle(title, maxLength = 20) {
    if (!title) return 'Untitled';
    const str = String(title).trim();
    return str.length > maxLength ? str.substring(0, maxLength) + '...' : str;
  }

  function getMediaIcon(type) {
    return mediaIcons[type] || mediaIcons.default;
  }

  // Short date formatter (e.g., "24 dic. 2025" or "1 gen. 2026")
  function formatDateShort(created) {
    if (!created) return null;
    const s = String(created).trim();
    // YYYY
    if (/^\d{4}$/.test(s)) return s;
    // YYYY-MM
    if (/^\d{4}-\d{2}$/.test(s)) {
      const [y, m] = s.split('-');
      const months = ['gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic'];
      const mi = parseInt(m,10)-1;
      if (mi >= 0 && mi < 12) return `${months[mi]}. ${y}`;
      return s;
    }
    // Try parsing full date/time
    const dt = new Date(s);
    if (!isNaN(dt.getTime())) {
      const day = dt.getDate();
      const months = ['gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic'];
      const mon = months[dt.getMonth()];
      return `${day} ${mon}. ${dt.getFullYear()}`;
    }
    // Fallback: try extract YYYY-MM-DD
    const m2 = s.match(/(\d{4})-(\d{2})-(\d{2})/);
    if (m2) {
      const y = m2[1], mo = parseInt(m2[2],10)-1, d = parseInt(m2[3],10);
      const months = ['gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic'];
      const mon = months[mo] || m2[2];
      return `${d} ${mon}. ${y}`;
    }
    return s;
  }

  function buildUserItem(item) {
    const div = el('div', 'media-item');

    const img = el('img', 'media-icon user-icon');
    img.src = item.thumbnail || item.profile_picture_url || '/static/images/no pp.jpg';
    img.alt = item.username || 'user';

    const info = el('div', 'media-info');

    const h3 = el('h3');
    const a = el('a');
    const userId = item.username || item.id || '';
    a.href = `/home?form_type=profile&username=${encodeURIComponent(userId)}`;
    a.textContent = item.title || item.username || userId;
    h3.appendChild(a);

    const bio = el('p', 'user-bio', item.description || item.bio || '');

    info.append(h3, bio);
    div.append(img, info);

    return div;
  }

  function buildMediaItem(item) {
    const div = el('div', 'media-item');

    const img = el('img', 'media-icon');
    img.src = getMediaIcon(item.type);
    img.alt = item.type || '';

    const info = el('div', 'media-info');

    const h3 = el('h3');
    const a = el('a');
    const mediaId = item.id || item.media_id || item._id || item.link || '';
    a.href = `/show?media_id=${encodeURIComponent(mediaId)}`;
    a.target = '_blank';
    a.textContent = truncateTitle(item.title);
    h3.appendChild(a);

    const by = el('p');
    if (item.username) {
      const u = el('a', null, item.username);
      u.href = `/home?form_type=profile&username=${encodeURIComponent(item.username)}`;
      by.append('By: ', u);
    } else {
      by.textContent = 'By: Sconosciuto';
    }

    const tags = el(
      'p',
      null,
      'Tag: ' + (Array.isArray(item.tags) ? item.tags.join(', ') : '-')
    );

    // show publication date if available (short format)
    const dateP = el('p', null, '');
    const created = (item.raw && item.raw.created_at) ? item.raw.created_at : null;
    const formattedDate = formatDateShort(created);
    if (formattedDate) dateP.textContent = `Published: ${formattedDate}`;

    info.append(h3, by, tags, dateP);
    div.append(img, info);

    return div;
  }

  async function loadMore() {
    if (isLoading || endReached) return;

    isLoading = true;
    const token = ++loadToken;
    loadingEl.textContent = 'Caricamento...';

    try {
      const res = await fetch(
        `/feed/data?offset=${currentIndex}&limit=${batchSize}&filter=${currentFilter}&search=${encodeURIComponent(currentSearch)}`
      );
      const data = await res.json();

      if (!res.ok) {
        loadingEl.textContent = 'Errore nel caricamento';
        return;
      }

      if (token !== loadToken) return;

      if (currentIndex === 0) feedEl.innerHTML = '';

      if (!data || data.length === 0) {
        endReached = true;
        loadingEl.textContent = 'Fine dei risultati';
        observer.unobserve(sentinel);
        return;
      }

      data.forEach(item => {
        const node = item.type === 'user'
          ? buildUserItem(item)
          : buildMediaItem(item);
        feedEl.appendChild(node);
      });

      currentIndex += data.length;
      loadingEl.textContent = '';
    } catch (e) {
      console.error(e);
      loadingEl.textContent = 'Errore di rete';
    } finally {
      isLoading = false;
    }
  }

  function applySearch() {
    currentSearch = document.getElementById('search').value.trim();
    currentFilter = document.getElementById('filter').value;
    currentIndex = 0;
    endReached = false;
    loadingEl.textContent = '';
    observer.observe(sentinel);
    loadMore();
  }

  observer = new IntersectionObserver(entries => {
    if (entries[0].isIntersecting) loadMore();
  }, {
    rootMargin: '200px',
    threshold: 0.01
  });

  observer.observe(sentinel);
  loadMore();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Feed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='feed_style.css') }}">

</head>
<body>

<header>Feed</header>

<div class="search-bar">
  <input type="text" id="search" placeholder="Cerca...">
  <select id="filter">
    <option value="all">Tutti</option>
    <option value="user">Utente</option>
    <option value="title">Titolo</option>
    <option value="file">File</option>
    <option value="tag">Tag</option>
  </select>
  <button onclick="applySearch()">Cerca</button>
</div>

<div class="feed" id="feed"></div>
<div class="loading" id="loading">Caricamento...</div>

<div class="bottom-nav-box">
  <a href="{{ url_for('home.homepage', form_type='profile') }}" class="nav-item">
    <i class="fas fa-user"></i><span>Profile</span>
  </a>
  <a href="{{ url_for('home.homepage', form_type='feed') }}" class="nav-item">
    <i class="fas fa-rss"></i><span>Feed</span>
  </a>
  <a href="{{ url_for('home.homepage', form_type='libraries') }}" class="nav-item">
    <i class="fas fa-book"></i><span>Libraries</span>
  </a>
</div>


<script>
  let currentIndex = 0;
  const batchSize = 10;
  let currentFilter = 'all';
  let currentSearch = '';
  let isLoading = false;

  const feedEl = document.getElementById('feed');
  const loadingEl = document.getElementById('loading');

  async function loadMore() {
    if (isLoading) return;
    isLoading = true;
    loadingEl.textContent = "Caricamento...";
    
    try {
      const res = await fetch(`/feed/data?offset=${currentIndex}&limit=${batchSize}&filter=${currentFilter}&search=${encodeURIComponent(currentSearch)}`);
      const data = await res.json();

      if (res.ok) {
        if (currentIndex === 0) feedEl.innerHTML = '';
        if (data.length === 0) {
          loadingEl.textContent = "Fine dei risultati";
          return;
        }

        data.forEach(item => {
          const div = document.createElement('div');
          div.className = 'media-item';
          div.innerHTML = `
            <img src="${item.thumbnail || 'https://via.placeholder.com/120x120'}" alt="img">
            <div class="media-info">
              <h3><a href="${item.link || '#'}" target="_blank">${item.title}</a></h3>
              <p>Autore: ${item.username || 'Sconosciuto'}</p>
              <p>Tag: ${item.tags?.join(', ') || '-'}</p>
            </div>
          `;
          feedEl.appendChild(div);
        });

        currentIndex += data.length;
        loadingEl.textContent = "";
      } else {
        loadingEl.textContent = "Errore nel caricamento";
      }
    } catch (err) {
      console.error(err);
      loadingEl.textContent = "Errore di rete";
    } finally {
      isLoading = false;
    }
  }

  function handleScroll() {
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
      loadMore();
    }
  }

  function applySearch() {
    currentIndex = 0;
    feedEl.innerHTML = '';
    currentSearch = document.getElementById('search').value;
    currentFilter = document.getElementById('filter').value;
    loadMore();
  }

  window.addEventListener('scroll', handleScroll);
  window.addEventListener('DOMContentLoaded', () => loadMore());
</script>

</body>
</html>

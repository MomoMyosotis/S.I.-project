<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Libreria utente</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='libraries_style.css') }}">
</head>

<body>
<header>Libreria</header>

<div class="library-controls">
  <button id="tab-commented" class="tab-button active" onclick="switchTab('commented')">Media Commentati</button>
  <button id="tab-followed" class="tab-button" onclick="switchTab('followed')">Seguiti</button>
</div>

<div class="library" id="library-container"></div>
<div class="loading" id="loading">Caricamento...</div>
<div id="library-sentinel"></div>

<script>
  let currentIndex = 0;
  const batchSize = 10;

  let currentTab = 'commented';
  let isLoading = false;
  let endReached = false;
  let loadToken = 0;

  const containerEl = document.getElementById('library-container');
  const loadingEl = document.getElementById('loading');
  const sentinel = document.getElementById('library-sentinel');

  let observer;

  const mediaIcons = {
    song: '/static/images/song.png',
    document: '/static/images/document.png',
    video: '/static/images/video.png',
    link: '/static/images/concert.png',
    concert: '/static/images/concert.png',
    default: '/static/images/unknown.jpg'
  };

  const el = (tag, className, text) => {
    const e = document.createElement(tag);
    if (className) e.className = className;
    if (text !== undefined) e.textContent = text;
    return e;
  };

  function getMediaIcon(type) {
    return mediaIcons[type] || mediaIcons.default;
  }

  // Short date formatter (e.g., "24 dic. 2025" or "1 gen. 2026")
  function formatDateShort(created) {
    if (!created) return null;
    const s = String(created).trim();
    // YYYY
    if (/^\d{4}$/.test(s)) return s;
    // YYYY-MM
    if (/^\d{4}-\d{2}$/.test(s)) {
      const [y, m] = s.split('-');
      const months = ['gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic'];
      const mi = parseInt(m,10)-1;
      if (mi >= 0 && mi < 12) return `${months[mi]}. ${y}`;
      return s;
    }
    // Try parsing full date/time
    const dt = new Date(s);
    if (!isNaN(dt.getTime())) {
      const day = dt.getDate();
      const months = ['gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic'];
      const mon = months[dt.getMonth()];
      return `${day} ${mon}. ${dt.getFullYear()}`;
    }
    // Fallback: try extract YYYY-MM-DD
    const m2 = s.match(/(\d{4})-(\d{2})-(\d{2})/);
    if (m2) {
      const y = m2[1], mo = parseInt(m2[2],10)-1, d = parseInt(m2[3],10);
      const months = ['gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic'];
      const mon = months[mo] || m2[2];
      return `${d} ${mon}. ${y}`;
    }
    return s;
  }

  function buildMediaItem(item) {
    const div = el('div', 'media-item');

    const img = el('img', 'media-icon');
    img.src = getMediaIcon(item.type);
    img.alt = item.type || '';

    const info = el('div', 'media-info');

    const h3 = el('h3');
    const a = el('a');
    const mediaId = item.id || item.media_id || item._id || item.link || '';
    a.href = `/show?media_id=${encodeURIComponent(mediaId)}`;
    a.target = '_blank';
    a.textContent = item.title || 'Untitled';
    h3.appendChild(a);

    const by = el('p');
    if (item.username) {
      const u = el('a', null, item.username);
      u.href = `/home?form_type=profile&username=${encodeURIComponent(item.username)}`;
      by.append('By: ', u);
    } else {
      by.textContent = 'By: Sconosciuto';
    }

    const tags = el(
      'p',
      null,
      'Tag: ' + (Array.isArray(item.tags) ? item.tags.join(', ') : '-')
    );

    // show publication date if available (short format)
    const dateP = el('p', null, '');
    const created = (item.raw && item.raw.created_at) ? item.raw.created_at : null;
    const formattedDate = formatDateShort(created);
    if (formattedDate) dateP.textContent = `Published: ${formattedDate}`;

    info.append(h3, by, tags, dateP);
    div.append(img, info);

    return div;
  }

  async function loadMore() {
    if (isLoading || endReached) return;

    isLoading = true;
    const token = ++loadToken;
    loadingEl.textContent = 'Caricamento...';

    try {
      const endpoint = currentTab === 'commented' 
        ? '/library/commented_media'
        : '/library/followed_media';
      
      const res = await fetch(`${endpoint}?offset=${currentIndex}&limit=${batchSize}`);
      const data = await res.json();

      if (!res.ok) {
        loadingEl.textContent = 'Errore nel caricamento';
        return;
      }

      if (token !== loadToken) return;

      if (currentIndex === 0) containerEl.innerHTML = '';

      if (!data || data.length === 0) {
        endReached = true;
        loadingEl.textContent = 'Fine dei risultati';
        observer.unobserve(sentinel);
        return;
      }

      data.forEach(item => {
        const node = buildMediaItem(item);
        containerEl.appendChild(node);
      });

      currentIndex += data.length;
      loadingEl.textContent = '';
    } catch (e) {
      console.error(e);
      loadingEl.textContent = 'Errore di rete';
    } finally {
      isLoading = false;
    }
  }

  function switchTab(tab) {
    currentTab = tab;
    currentIndex = 0;
    endReached = false;
    loadingEl.textContent = '';
    
    // Update button states
    document.getElementById('tab-commented').classList.remove('active');
    document.getElementById('tab-followed').classList.remove('active');
    document.getElementById(`tab-${tab}`).classList.add('active');
    
    // Reset observer
    observer.unobserve(sentinel);
    observer.observe(sentinel);
    loadMore();
  }

  observer = new IntersectionObserver(entries => {
    if (entries[0].isIntersecting) loadMore();
  }, {
    rootMargin: '200px',
    threshold: 0.01
  });

  observer.observe(sentinel);
  loadMore();
</script>

<style>
  /* HEADER ANIMATO */
  @property --a { syntax: "<angle>"; inherits: false; initial-value: 0deg; }
  @keyframes rotating { 0% { --a:0deg; } 100% { --a:360deg; } }

  header {
    position: sticky;
    top: 0;
    width: 100%;
    max-width: 480px;
    margin: 10px auto;
    padding: 20px 0;
    text-align: center;
    font-size: 1.8em;
    font-weight: 700;
    color: #fff;
    border-radius: 20px;
    background: repeating-conic-gradient(from var(--a), #ff2770 0%, #ff2770 5%, transparent 5%, transparent 40%, #ff2770 50%);
    animation: rotating 4s linear infinite;
    filter: drop-shadow(0 15px 50px #000);
    text-shadow: 0 0 10px #ff2770;
    box-shadow: 0 2px 5px rgba(255,39,112,0.5);
    letter-spacing: 0.05em;
    z-index: 1;
    user-select: none;
  }

  /* TAB BUTTONS */
  .library-controls {
    display: flex;
    gap: 12px;
    padding: 15px 20px;
    background-color: #2d2d39;
    border-radius: 15px;
    margin: 10px auto;
    max-width: 480px;
    box-shadow: inset 0 0 10px #ff2770cc;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
  }

  .tab-button {
    padding: 10px 20px;
    border-radius: 12px;
    border: 2px solid #ff2770;
    background-color: transparent;
    color: #ff2770;
    font-size: 1em;
    font-weight: 600;
    cursor: pointer;
    outline: none;
    transition: all 0.3s ease;
  }

  .tab-button:hover {
    background-color: #ff2770;
    color: #2d2d39;
  }

  .tab-button.active {
    background-color: #ff2770;
    color: #fff;
    box-shadow: 0 0 15px #ff2770;
  }

  /* MEDIA ITEMS */
  .library {
    display: flex;
    flex-direction: column;
    gap: 15px;
    padding: 0 20px 100px;
    max-width: 480px;
    margin: 0 auto;
  }

  .media-item {
    display: flex;
    background-color: #2d2d39;
    border-radius: 15px;
    box-shadow: 0 0 15px #ff2770aa;
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .media-item:hover {
    transform: scale(1.05);
    box-shadow: 0 0 25px #ff2770ee;
  }

  .media-icon {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border-radius: 15px 0 0 15px;
    flex-shrink: 0;
  }

  .media-info {
    padding: 15px 20px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    color: #eee;
    flex: 1;
  }

  .media-info h3 {
    margin: 0 0 8px;
    font-weight: 700;
    font-size: 1.3em;
  }

  .media-info h3 a {
    color: #ff2770;
    text-decoration: none;
  }

  .media-info h3 a:hover {
    color: #45f3ff;
    text-shadow: 0 0 8px #45f3ff;
  }

  .media-info p {
    margin: 0;
    font-size: 0.95em;
    color: #bbb;
  }

  /* LOADING */
  .loading {
    text-align: center;
    padding: 15px;
    font-size: 1.1em;
    color: #ff2770;
    text-shadow: 0 0 10px #ff2770;
  }
</style>

</body>
</html>

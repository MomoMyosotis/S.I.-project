<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profilo Utente</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='profile_style.css') }}" />
</head>
<body>

<main class="profile-container" role="main" aria-label="Profilo utente">

  <!-- Intestazione profilo -->
  <section class="profile-header" aria-label="Informazioni utente">
    <img
      id="profile-picture"
      src=""
      alt="Foto profilo"
      class="profile-picture"
      width="180"
      height="180"
    />
    <div class="profile-info">
      <h1 id="username" tabindex="0">@loading...</h1>

      <!-- moved stats into the header to save vertical space -->
      <div class="header-stats" role="region" aria-label="Statistiche utente">
        <div class="stat">
          <span class="label">Pubblicazioni</span>
          <span id="publications-count" class="value stat-counter">0</span>
        </div>
        <div class="stat">
          <span class="label">Followers</span>
          <span id="followers-count" class="value stat-counter">0</span>
        </div>
        <div class="stat">
          <span class="label">Following</span>
          <span id="following-count" class="value stat-counter">0</span>
        </div>
      </div>

    </div>
  </section>

  <!-- Sezione Bio -->
  <section class="profile-full-bio" aria-label="Biografia utente" role="region">
    <h2 tabindex="0">Biography</h2>
    <p id="full-bio" class="bio-collapsed">Nessuna biografia disponibile.</p>

    <button id="toggle-bio-btn" class="toggle-bio-btn" style="display:none">
      Mostra di più
    </button>
  </section>

  <!-- Azioni profilo -->
  <section id="profile-actions" class="profile-actions" aria-label="Azioni profilo" role="region">
  </section>

  <!-- Elenco Pubblicazioni -->
  <section class="profile-recent" aria-label="Pubblicazioni recenti" role="region">
    <h2 tabindex="0">Pubblicazioni</h2>

    <!-- skeleton shown while loading -->
    <div id="publications-skeleton" class="pub-skeleton" aria-hidden="true" style="display:none">
      <div class="s-item"></div>
      <div class="s-item"></div>
      <div class="s-item"></div>
      <div class="s-item"></div>
    </div>

    <!-- container with fixed height and scroll (collapsible) -->
    <div id="pubs-container" class="pubs-container collapsed" aria-live="polite">
      <ul id="recent-publications" class="pub-grid"></ul>
    </div>

    <p id="no-publications" tabindex="0" style="display:none">Nessuna pubblicazione recente.</p>

    <!-- controls: expand + load more -->
    <div class="load-more-wrap">
      <button id="toggle-pubs-btn" class="toggle-pubs-btn" style="display:inline-block">Mostra altro</button>
      <button id="load-more-btn" class="load-more-btn" style="display:none">Carica altre pubblicazioni</button>
    </div>
  </section>

</main>

<script type="module">

  const params = new URLSearchParams(window.location.search);
  const viewedUsername = params.get("username");

  // pagination & state
  let currentOffset = 0;
  const pageLimit = 5;
  let totalPublications = null;
  let loading = false;

  async function loadProfile() {
    try {
      showSkeleton(true);
      const url = viewedUsername
        ? `/profile/data?username=${encodeURIComponent(viewedUsername)}`
        : `/profile/data`;

      const res = await fetch(url);
      if (!res.ok) throw new Error("Response non OK");

      const data = await res.json();
      updateUI(data.user);
      // pass both viewer (data.self) and the target user (data.user)
      updateActions(data.self, data.user);
      attachBioToggle();

      // initial publications chunk from profile endpoint
      const initial = data.recent_publications || [];
      updatePublications(initial, true);
      currentOffset = initial.length;
      totalPublications = data.user?.publications_count ?? null;
      renderLoadMoreButton();
      animateCounters();
    } catch (err) {
      console.error("[DEBUG][loadProfile] Errore:", err);
      document.getElementById("username").textContent = "@error";
    } finally {
      showSkeleton(false);
    }
  }

  function showSkeleton(show = true) {
    const el = document.getElementById("publications-skeleton");
    if (el) el.style.display = show ? "grid" : "none";
  }

  function renderLoadMoreButton() {
    const btn = document.getElementById("load-more-btn");
    if (!btn) return;
    // show when we don't know total OR offset < total
    if (totalPublications === null || currentOffset < totalPublications) {
      btn.style.display = "inline-block";
      btn.onclick = loadMorePublications;
    } else {
      btn.style.display = "none";
    }
  }

  async function loadMorePublications() {
    if (loading) return;
    loading = true;
    showSkeleton(true);
    try {
      const usernameParam = viewedUsername ? `&username=${encodeURIComponent(viewedUsername)}` : "";
      const res = await fetch(`/profile/publications?offset=${currentOffset}&limit=${pageLimit}${usernameParam}`);
      if (!res.ok) throw new Error("fetch pubblicazioni fallito");
      const data = await res.json();
      const pubs = data.publications || [];
      const count = data.count;
      if (typeof count === "number") totalPublications = count;
      updatePublications(pubs, false);
      currentOffset += pubs.length;
      const pubsEl = document.getElementById("publications-count");
      if (pubsEl && totalPublications !== null) pubsEl.textContent = totalPublications;
      renderLoadMoreButton();
    } catch (err) {
      console.error("[DEBUG][loadMorePublications] Errore:", err);
    } finally {
      loading = false;
      showSkeleton(false);
    }
  }

  function updatePublications(list, replace = false) {
    const ul = document.getElementById("recent-publications");
    const emptyMsg = document.getElementById("no-publications");
    if (!ul) return;
    if (replace) ul.innerHTML = "";

    if ((ul.children.length + list.length) === 0) {
      if (emptyMsg) emptyMsg.style.display = "block";
      return;
    }
    if (emptyMsg) emptyMsg.style.display = "none";

    list.forEach(pub => {
      const li = document.createElement("li");
      li.className = "publication-card";
      li.innerHTML = `
        <div class="card-thumb"><img src="/static/images/song.png" alt="thumb"></div>
        <div class="card-body">
          <strong class="card-title">${escapeHtml(pub.title)}</strong>
          <p class="card-desc">${escapeHtml(pub.description)}</p>
          <div class="card-meta">${escapeHtml(pub.date_published)}</div>
        </div>
      `;
      ul.appendChild(li);
    });
  }

  function escapeHtml(str = "") {
    return String(str || "").replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // populate header, stats and bio
  function updateUI(user = {}) {
    const nameEl = document.getElementById("username");
    const picEl = document.getElementById("profile-picture");
    const fullBioEl = document.getElementById("full-bio");
    const pubsEl = document.getElementById("publications-count");
    const followersEl = document.getElementById("followers-count");
    const followingEl = document.getElementById("following-count");

    if (nameEl) nameEl.textContent = "@" + (user.username || "unknown");
    // use "no pp.jpg" from static/images when no profile picture is available
    if (picEl) {
      const defaultPic = "/static/images/no pp.jpg";
      // if server returned a profile_pic id, use the client proxy endpoint to fetch it
      if (user.profile_pic) {
        picEl.src = `/profile/picture/${encodeURIComponent(user.profile_pic)}`;
      } else {
        picEl.src = user.profile_picture_url || encodeURI(defaultPic);
      }
    }
    if (fullBioEl) {
      fullBioEl.textContent = user.full_bio ?? user.bio ?? "Nessuna biografia disponibile.";
      // collapsed by default
      fullBioEl.classList.add("bio-collapsed");
    }
    if (pubsEl) {
      pubsEl.textContent = user.publications_count ?? 0;
      pubsEl.classList.add("stat-counter");
      pubsEl.dataset.target = user.publications_count ?? 0;
    }
    if (followersEl) {
      followersEl.textContent = user.followers_count ?? user.followers ?? 0;
      followersEl.classList.add("stat-counter");
      followersEl.dataset.target = followersEl.textContent;
    }
    if (followingEl) {
      followingEl.textContent = user.following_count ?? user.followed ?? 0;
      followingEl.classList.add("stat-counter");
      followingEl.dataset.target = followingEl.textContent;
    }
  }

  // render action buttons depending on ownership
  function updateActions(viewer = {is_self:false}, targetUser = {}) {
    const container = document.getElementById("profile-actions");
    if (!container) return;
    container.innerHTML = "";

    // debug: mostra i payload ricevuti nella console per verificare i campi
    // (rimuovere in produzione)
    console.debug("[DEBUG][updateActions] viewer:", viewer, "targetUser:", targetUser);

    // normalise viewer fields (server may return different keys)
    const viewerId = viewer?.id ?? viewer?.user_id ?? null;
    let viewerLvl = Number(viewer?.lvl ?? viewer?.level ?? viewer?.level_id ?? -1);

    // se non abbiamo il livello del viewer ma stiamo visualizzando il profilo
    // della stessa persona, proviamo a leggere il livello dal targetUser (fallback)
    const isSelf = viewer?.is_self === true || (viewerId && viewerId === (targetUser?.id ?? targetUser?.user_id));
    if ((Number.isNaN(viewerLvl) || viewerLvl < 0) && isSelf) {
      viewerLvl = Number(targetUser?.lvl ?? targetUser?.level ?? targetUser?.level_id ?? viewerLvl);
    }

    // assicurati che viewerLvl sia un numero valido
    if (Number.isNaN(viewerLvl)) viewerLvl = -1;

    const isFollowing = Boolean(viewer?.is_following ?? viewer?.following ?? viewer?.follows ?? targetUser?.is_followed ?? false);

    // Edit button: if same user OR viewer lvl is 0 or 1
    const canEdit = isSelf || viewerLvl === 0 || viewerLvl === 1;
    if (canEdit) {
      container.insertAdjacentHTML("beforeend",
        `<button class="edit-btn" onclick="editProfile()">Modifica Profilo</button>`);
    }

    // Publish button: if viewer is self OR viewer lvl is 0,1,3
    if (isSelf || [0,1,3].includes(viewerLvl)) {
      container.insertAdjacentHTML("beforeend",
        `<button class="edit-btn" onclick="window.location.href='/publish.html'">Pubblica</button>`);
    }

    // Follow / Unfollow only when viewing other user's profile and viewer is logged
    if (!isSelf && viewerId) {
      const btnText = isFollowing ? "Unfollow" : "Segui";
      container.insertAdjacentHTML("beforeend",
        `<button id="follow-btn" class="follow-btn">${btnText}</button>`);
      const btn = document.getElementById("follow-btn");
      if (btn) btn.addEventListener("click", () => toggleFollow(targetUser.username ?? targetUser?.id));
    }
  }

  function attachBioToggle() {
    const btn = document.getElementById("toggle-bio-btn");
    const full = document.getElementById("full-bio");
    if (!btn || !full) return;
    btn.style.display = full.textContent.length > 120 ? "inline-block" : "none";
    btn.textContent = "Mostra di più";
    btn.onclick = () => {
      if (full.classList.contains("bio-collapsed")) {
        full.classList.remove("bio-collapsed");
        btn.textContent = "Mostra di meno";
      } else {
        full.classList.add("bio-collapsed");
        btn.textContent = "Mostra di più";
      }
    };
  }

  function editProfile() {
    window.location.href = "/profile/edit";  }
  window.editProfile = editProfile;
  async function toggleFollow(targetIdentifier) {
    try {
      const username = viewedUsername || targetIdentifier;
      if (!username) return;
      const followBtn = document.getElementById("follow-btn");
      const action = followBtn && followBtn.textContent.trim().toLowerCase() === "segui" ? "follow" : "unfollow";
      const res = await fetch(`/profile/${action}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username })
      });
      if (!res.ok) throw new Error("Request failed");
      const j = await res.json();
      // toggle label on success (backend should return success flag)
      if (j && (j.status === "OK" || j.success === true)) {
        if (followBtn) followBtn.textContent = action === "follow" ? "Unfollow" : "Segui";
        // update followers counter if present
        const followersEl = document.getElementById("followers-count");
        if (followersEl) {
          let cur = Number(followersEl.textContent || 0);
          followersEl.textContent = action === "follow" ? cur + 1 : Math.max(0, cur - 1);
        }
      }
    } catch (err) {
      console.error("[DEBUG][toggleFollow] Errore:", err);
    }
  }
  window.toggleFollow = toggleFollow;
  loadProfile();
</script>

</body>
</html>